# Template file for 'librewolf'
pkgname=librewolf
version=146.0
revision=1
_rev=2
wrksrc=${pkgname}-${version}-${_rev}
build_helper="rust"
short_desc="LibreWolf web browser - modified by zveihander for aarch64-musl (asahi)"
maintainer="Evan Alvarez <lwq7e50ygv8f1w@tuta.com>"
license="GPL-3.0-only AND LGPL-2.1-only AND LGPL-3.0-only AND MPL-2.0"
homepage="https://librewolf.net/"
distfiles="https://gitlab.com/api/v4/projects/32320088/packages/generic/librewolf-source/${version}-${_rev}/${pkgname}-${version}-${_rev}.source.tar.gz"
checksum=244784bac847344feb091ef7605370a8267df04bf0a71a4a03f01c11b8610046

lib32disabled=yes

_llvmver=21
hostmakedepends="unzip zip pkg-config perl python3 yasm rust
 cargo llvm${_llvmver} clang${_llvmver} lld${_llvmver} rust-sccache nodejs cbindgen nasm which
 tar xz $(vopt_if pgo 'dbus mesa-dri vulkan-loader pciutils')
 $(vopt_if wasi wasi-sdk)"
makedepends="nss-devel libjpeg-turbo-devel gtk+3-devel
 pixman-devel libevent-devel libnotify-devel libvpx-devel libwebp-devel
 rust-std freetype-devel pipewire-devel libicu-devel $(vopt_if wasi wasi-sdk) $(vopt_if dbus dbus-devel)"
depends="nss>=3.72 nspr>=4.32 desktop-file-utils hicolor-icon-theme pciutils"

build_options="dbus pulseaudio wayland lto pgo clang wasi"
build_options_default="dbus pulseaudio wayland lto pgo clang wasi"

if [ "$XBPS_WORDSIZE" != "32" ]; then
	build_options_default+=" debug"
fi

desc_option_lto="Enable Link Time Optimization"
desc_option_pgo="Enable Profile-guided Optimization"
desc_option_clang="Build with clang"
desc_option_wasi="Build wasm sandboxed libraries"

case $XBPS_TARGET_MACHINE in
	armv[56]*) broken="required NEON extensions are not supported on armv6" ;;
	ppc64*) ;;
	ppc*) broken="xptcall bitrot" ;;
esac

if [ "$CROSS_BUILD" -a "$build_option_pgo" ]; then
	broken="pgo can't be enabled for cross-compilation"
fi

# we need this because cargo verifies checksums of all files in vendor
# crates when it builds and gives us no way to override or update the
# file sanely... so just clear out the file list
_clear_vendor_checksums() {
	sed -i 's/\("files":{\)[^}]*/\1/' third_party/rust/$1/.cargo-checksum.json
}

post_extract() {
	case "$XBPS_TARGET_MACHINE" in
	*-musl)
		cp "${FILESDIR}/stab.h" toolkit/crashreporter/google-breakpad/src/
		;;
	esac

	# Mozilla API keys (see https://location.services.mozilla.com/api)
	# Note: This is for Void Linux use ONLY.
	echo -n "cd894504-7a2a-4263-abff-ff73ee89ffca" > mozilla-api-key
}

post_patch() {
	: # _clear_vendor_checksums num-traits
	if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
		vsed -e '\;sys/single_threaded.h;d' -i config/system-headers.mozbuild
	fi
}

do_build() {
    export SCCACHE_DIR="${XBPS_BUILDDIR}/sccache"
    export SCCACHE_CACHE_SIZE="20G"
	export AS="${CC}"
	export CFLAGS="-O3 -mcpu=native -fno-plt -fstack-protector-strong -mbranch-protection=standard -D_FORTIFY_SOURCE=3 -pipe"
	export CXXFLAGS="-O3 -mcpu=native -fno-plt -fstack-protector-strong -mbranch-protection=standard -D_FORTIFY_SOURCE=3 -pipe"
	unset HOST_CFLAGS
	unset HOST_CXXFLAGS
   	export LDFLAGS="-Wl,-O2 -Wl,-rpath=/usr/lib/librewolf -Wl,--as-needed -Wl,-z,now -Wl,-z,relro -Wl,--gc-sections"
    export RUSTFLAGS="-C target-cpu=native -C link-arg=-Wl,-z,relro -C opt-level=3 -C link-arg=-Wl,-z,now"
	# export LDFLAGS+="-Wl,--threads=${XBPS_MAKEJOBS}"

	if [ "$build_option_clang" ]; then
		export CC=clang
		export CXX=clang++
		export AR=llvm-ar
		export NM=llvm-nm
		export HOST_CC=clang
		export HOST_CXX=clang++
	fi

	disable_jemalloc() {
		if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
			echo "ac_add_options --disable-jemalloc"
		fi
	}

	disable_elfhack() {
		case "$XBPS_TARGET_MACHINE" in
		x86_64*|i686*|arm*|aarch64*) echo "ac_add_options --disable-elf-hack" ;;
		esac
	}

	disable_webrtc() {
		# it seems mozilla has started catching up with google's webrtc
		# and this newly involves introducing several megabytes of generated
		# json junk that we just cannot maintain in-tree, additionally they
		# have indicated that they will be re-generating these frequently
		#
		# it is unacceptable to keep a 7MB patch downstream, so disable it
		#
		# https://phabricator.services.mozilla.com/D134738
		#
		case "$XBPS_TARGET_MACHINE" in
		armv7l*) echo "ac_add_options --disable-webrtc" ;;
		esac

		# third_party/libwebrtc/common_audio/wav_file.cc:93:2: error:
		# #error "Need to convert samples to big-endian when reading from WAV file"
		if [ "$XBPS_TARGET_ENDIAN" = "be" ]; then
			echo "ac_add_options --disable-webrtc"
		fi
	}

	disable_wasi() {
		if [ "$build_option_wasi" ]; then
			echo "ac_add_options --with-wasi-sysroot=/usr/share/wasi-sysroot"
		else
			echo "ac_add_options --without-wasm-sandboxed-libraries"
		fi
	}

    disable_unneeded() {
      # audio and hardware
      echo "ac_add_options --disable-alsa"
	  echo "ac_add_options --disable-jack"
	  echo "ac_add_options --disable-sndio"
	  echo "ac_add_options --disable-xscreensaver"
      echo "ac_add_options --disable-webspeech"
      echo "ac_add_options --disable-gamepad"

      # telemetry
      echo "ac_add_options --disable-telemetry"
      echo "ac_add_options --disable-glean"
      echo "ac_add_options --disable-normandy"
      echo "ac_add_options --disable-healthreport"
      echo "ac_add_options --disable-crashreporter"
      echo "ac_add_options --disable-updater"
      echo "ac_add_options --disable-pioneer"

      # bloat
      echo "ac_add_options --disable-tests"
      echo "ac_add_options --disable-debug"
      echo "ac_add_options --disable-pocket"
      echo "ac_add_options --disable-parental-controls"
      echo "ac_add_options --disable-accessibility"
      echo "ac_add_options --disable-vtune"
      echo "ac_add_options --disable-google-sse"
    }

	cat <<-! >mozconfig
	ac_add_options --prefix=/usr
	ac_add_options --libdir=/usr/lib
	ac_add_options --host=${XBPS_TRIPLET}
	ac_add_options --target=${XBPS_CROSS_TRIPLET:-${XBPS_TRIPLET}}
	ac_add_options --enable-linker=lld
	ac_add_options --disable-bootstrap
	$(vopt_if lto 'ac_add_options --enable-lto=thin')
	$(vopt_if clang 'ac_add_options --with-libclang-path=/usr/lib')

    ac_add_options --with-ccache=sccache


	ac_add_options --enable-application=browser
	ac_add_options --enable-release
	ac_add_options --enable-hardening
	ac_add_options --enable-optimize="\${CFLAGS}"
	ac_add_options --enable-path-remapping=c,rust
	ac_add_options --enable-packed-relative-relocs
	ac_add_options --disable-cargo-incremental
	ac_add_options --disable-tests
	ac_add_options --disable-crashreporter
	ac_add_options --disable-updater
	ac_add_options --disable-profiling

    ac_add_options --disable-webspeech

    $(disable_unneeded)

	$(disable_jemalloc)
	$(disable_elfhack)
	$(disable_webrtc)
	$(disable_wasi)
	ac_add_options --with-mozilla-api-keyfile="${wrksrc}/mozilla-api-key"
	ac_add_options --enable-system-pixman
	ac_add_options --with-system-ffi
	ac_add_options --with-system-jpeg
	ac_add_options --with-system-libevent
	ac_add_options --with-system-libvpx
	ac_add_options --with-system-nspr
	ac_add_options --with-system-nss
	ac_add_options --with-system-webp
	ac_add_options --with-system-zlib
    ac_add_options --with-system-icu
	# XXX: the system's libpng doesn't have APNG support
	ac_add_options --without-system-png
	ac_add_options --with-unsigned-addon-scopes=app,system
	ac_add_options --allow-addon-sideload
	ac_add_options $(vopt_enable dbus)
	ac_add_options --disable-audio-backends
	ac_add_options $(vopt_enable pulseaudio)
	ac_add_options --enable-default-toolkit=cairo-gtk3-wayland-only
    ac_add_options --disable-x11

	mk_add_options MOZ_OBJDIR="${wrksrc}/obj"

	# LibreWolf
	MOZ_APP_REMOTINGNAME=librewolf
	ac_add_options --disable-debug
	ac_add_options --disable-default-browser-agent
	ac_add_options --enable-rust-simd

	ac_add_options --with-app-name=librewolf
	ac_add_options --with-branding=browser/branding/librewolf
	ac_add_options --with-l10n-base=$PWD/lw/l10n

	export MOZ_REQUIRE_SIGNING=

	mk_add_options MOZ_CRASHREPORTER=0
	mk_add_options MOZ_DATA_REPORTING=0
	mk_add_options MOZ_SERVICES_HEALTHREPORT=0
	mk_add_options MOZ_TELEMETRY_REPORTING=0
	!

	# XXX: setting --enable-debug/--enable-debug-symbols explicitly
	# seems to result in a laggy/crashy firefox.
	if [ -z "$build_option_debug" ]; then
		echo "ac_add_options --disable-debug-symbols" >>mozconfig
		echo "ac_add_options --disable-debug" >>mozconfig
	fi

	# work around large debug symbols on 32-bit hosts
	if [ "$XBPS_WORDSIZE" = "32" ]; then
		echo "ac_add_options --disable-debug-symbols" >>mozconfig
		echo "ac_add_options --disable-debug" >>mozconfig
		export LDFLAGS+=" -Wl,--no-keep-memory"
	fi

	if [ "$SOURCE_DATE_EPOCH" ]; then
		export MOZ_BUILD_DATE=$(date --date "@$SOURCE_DATE_EPOCH" "+%Y%m%d%H%M%S")
	fi

	export MOZ_MAKE_FLAGS="${makejobs}"
	export MOZ_NOSPAM=1
	export MOZBUILD_STATE_PATH="${wrksrc}/mozbuild"
	export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=system

	rm -f old-configure

	if [ "$build_option_pgo" ]; then
		cp mozconfig{,.orig}
		echo "ac_add_options --enable-profile-generate=cross" >> mozconfig

		./mach build
		./mach package

		XDG_RUNTIME_DIR="$(mktemp -d "${wrksrc}/pgo-runtime-XXXXXX")"
        trap "rm -rf $XDG_RUNTIME_DIR" EXIT

		LLVM_PROFDATA=llvm-profdata \
		JARLOG_FILE="$PWD/jarlog" \
        MOZ_HEADLESS=1 \
		GDK_BACKEND=wayland \
		LD_LIBRARY_PATH="$PWD/obj/dist/firefox" \
		dbus-run-session -- ./mach python build/pgo/profileserver.py


		test -s merged.profdata
		test -s jarlog

		./mach clobber objdir

		cp mozconfig{.orig,}
		cat <<-! >>mozconfig
		ac_add_options --enable-lto=cross,full
		ac_add_options --enable-profile-use=cross
		ac_add_options --with-pgo-profile-path=${PWD@Q}/merged.profdata
		ac_add_options --with-pgo-jarlog=${PWD@Q}/jarlog
		!
	fi

	./mach build
}

do_install() {
	export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=system
	export MOZBUILD_STATE_PATH="${wrksrc}/mozbuild"
	DESTDIR="$DESTDIR" ./mach install

    llvm-strip --strip-unneeded ${DESTDIR}/usr/lib/librewolf/librewolf
    llvm-strip --strip-unneeded ${DESTDIR}/usr/lib/librewolf/librewolf-bin

	vinstall ${FILESDIR}/vendor.js 644 usr/lib/librewolf/browser/defaults/preferences
	vinstall ${FILESDIR}/librewolf.desktop 644 /usr/share/applications/

	for i in 16x16 32x32 48x48 64x64 128x128; do
		vinstall ${wrksrc}/browser/branding/librewolf/default${i%x*}.png 644 \
			usr/share/icons/hicolor/${i}/apps librewolf.png
	done

	# We don't want the development stuff
	rm -rf ${DESTDIR}/usr/{include,lib/firefox-devel,share/idl}

	# https://bugzilla.mozilla.org/show_bug.cgi?id=658850
	ln -sf librewolf ${DESTDIR}/usr/lib/librewolf/librewolf-bin

	ln -sf librewolf ${DESTDIR}/usr/bin/librewolf-wayland
}
